<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Speaker Selector</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
 body{font-family:system-ui,sans-serif;padding:1rem;background:#f9fafb;color:#111;line-height:1.4}
 h1{font-size:1.8rem;margin-bottom:1rem}
 .filters{display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem;align-items:center}
 label{font-size:.85rem;font-weight:600;margin-right:.25rem}
 select,input[type=number],input[type=text]{padding:.25rem .5rem;font-size:.85rem}
 table{border-collapse:collapse;width:100%;background:#fff}
 th,td{border:1px solid #e5e7eb;padding:.5rem;text-align:left;font-size:.85rem}
 th{background:#f1f5f9;cursor:pointer;user-select:none}
 th.sort-asc::after{content:" ▲"}
 th.sort-desc::after{content:" ▼"}
 tbody tr:nth-child(odd){background:#f9fafb}
 td.edit-cell{background:#fff8dc}
 button{padding:.4rem .8rem;border:1px solid #ccc;border-radius:4px;background:#fff;cursor:pointer;font-size:.85rem}
 .btn-bar{margin:.5rem 0;display:flex;gap:.5rem}
 a.link{color:#0d6efd;text-decoration:underline}
</style>
</head>
<body>
<h1>Speaker Selector</h1>
<!-- ░░ Filters ░░ -->
<div class="filters">
 <div><label for="mountFilter">Mount:</label>
  <select id="mountFilter"><option value="">Any</option><option>surface mount</option><option>ceiling mount</option><option>pendant</option></select></div>
 <div><label for="powerMin">Min RMS W:</label><input id="powerMin" type="number" min="0" placeholder="0" style="width:5rem"></div>
 <div><label for="impFilter">Impedance:</label>
  <select id="impFilter"><option value="">Any</option><option>4</option><option>6</option><option>8</option><option>16</option></select></div>
 <div><label><input id="weathFilter" type="checkbox"> Weatherproof</label></div>
 <div><label><input id="lineFilter" type="checkbox"> 100 V capable</label></div>
 <div><label for="searchBox">Search:</label><input id="searchBox" type="text" placeholder="brand or model"></div>
</div>
<!-- ░░ Buttons ░░ -->
<div class="btn-bar"><button id="dlBtn">Download JSON</button><button id="saveBtn">Save to GitHub</button></div>
<!-- ░░ Table ░░ -->
<table>
<thead><tr id="headRow">
  <th data-k="brand">Brand</th><th data-k="model">Model</th><th data-k="mount_type">Mount</th>
  <th data-k="rms_power_w" data-num>RMS W</th><th data-k="impedance_ohm" data-num>Ω</th>
  <th data-k="sensitivity_db_1w1m" data-num>Sens dB</th><th data-k="max_spl_db" data-num>Max SPL</th>
  <th data-k="dispersion_deg">Disp H°/V°</th><th data-k="driver_configuration">Driver</th>
  <th data-k="dimensions_mm">Dims mm</th><th data-k="cutout_dimensions_mm" data-num>Cut‑out Ø mm</th>
  <th data-k="weatherproof">Weather</th><th data-k="max_tap_w_100v" data-num>100 V max</th>
  <th data-k="price_eur" data-num>Price €</th><th data-k="buy_link">Link</th>
</tr></thead>
<tbody id="body"><tr><td colspan="15" style="text-align:center">Loading…</td></tr></tbody>
</table>
<script>
// ░░ Config ░░
const BRANCH="main";const BUNDLE="speakers.json";const FALLBACK=["audac-ateo4mk2-8ohm.json","audac-ateo4d-16ohm.json","audac-cira724-8ohm.json","biamp-c-ic6-8ohm.json","bose-dm5c-8ohm.json","bose-dm5se-8ohm.json","bose-dm6c-8ohm.json","bose-dm6se-8ohm.json","bose-dm8s-8ohm.json","bose-dm10s-sub-8ohm.json"];
let products=[],sortKey=null,sortAsc=true,token=sessionStorage.getItem("gh_tok")||"";
// ░░ Detect repo info from URL ░░
function repoInfo(){if(!location.hostname.endsWith("github.io"))return null;const owner=location.hostname.split(".")[0];const parts=location.pathname.split("/").filter(Boolean);if(parts.length<1)return null;const repo=parts[0];const path=parts.slice(1,-1).join("/");return{owner,repo,path};}
// ░░ Fetch helpers ░░
async function jget(u){const r=await fetch(u);if(!r.ok)throw new Error(r.status);return r.json();}
async function loadAll(){const ri=repoInfo();let urls=[];if(ri){const base=`https://raw.githubusercontent.com/${ri.owner}/${ri.repo}/${BRANCH}/${ri.path?ri.path+'/':''}`;if(BUNDLE){try{products=(await jget(base+BUNDLE)).map(nrm);initUI();return;}catch{}}
 try{const api=`https://api.github.com/repos/${ri.owner}/${ri.repo}/contents/${ri.path}?ref=${BRANCH}`;const list=await jget(api);urls=list.filter(f=>f.name.endsWith('.json')).map(f=>f.download_url);}catch{}}
 if(!urls.length)urls=FALLBACK.map(f=>`./${f}`);
 await Promise.all(urls.map(u=>jget(u).then(d=>products.push(nrm(d))).catch(console.warn)));
 initUI();}
function nrm(o){if(o.price_eur===undefined)o.price_eur="";if(o.buy_link===undefined)o.buy_link="";return o;}
// ░░ UI ░░
function initUI(){document.querySelectorAll('#headRow th').forEach(th=>th.onclick=()=>{const k=th.dataset.k;sortAsc=sortKey===k?!sortAsc:true;sortKey=k;document.querySelectorAll('#headRow th').forEach(h=>h.classList.remove('sort-asc','sort-desc'));th.classList.add(sortAsc?'sort-asc':'sort-desc');apply();});['mountFilter','powerMin','impFilter','weathFilter','lineFilter','searchBox'].forEach(id=>document.getElementById(id).addEventListener('input',apply));document.getElementById('dlBtn').onclick=download;document.getElementById('saveBtn').onclick=save;apply();}
function apply(){const g=id=>document.getElementById(id);const m=g('mountFilter').value,pmin=+g('powerMin').value||0,imp=g('impFilter').value,w=g('weathFilter').checked,l=g('lineFilter').checked,t=g('searchBox').value.toLowerCase();let list=products.filter(p=>(!m||p.mount_type===m)&&(p.rms_power_w>=pmin)&&(!imp||String(p.impedance_ohm)===imp)&&(!w||p.weatherproof)&&(!l||p.has_100v_taps)&&(!t||(p.brand+" "+p.model).toLowerCase().includes(t)));if(sortKey)list.sort((a,b)=>((v(a)>v(b)?1:-1)*(sortAsc?1:-1)));render(list);function v(o){switch(sortKey){case'dispersion_deg':return o.dispersion_deg.horizontal;case'dimensions_mm':return o.dimensions_mm.width;case'cutout_dimensions_mm':return o.cutout_dimensions_mm?.diameter;case'weatherproof':return o.weatherproof?1:0;case'price_eur':return parseFloat(o.price_eur)||0;default:return o[sortKey];}}}
function render(arr){const tb=document.getElementById('body');tb.innerHTML='';if(!arr.length){tb.innerHTML='<tr><td colspan="15" style="text-align:center">No matches</td></tr>';return;}arr.forEach(p=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${p.brand}</td><td>${p.model}</td><td>${p.mount_type}</td><td>${p.rms_power_w}</td><td>${p.impedance_ohm}</td><td>${p.sensitivity_db_1w1m??'–'}</td><td>${p.max_spl_db??'–'}</td><td>${p.dispersion_deg.horizontal}/${p.dispersion_deg.vertical}</td><td>${p.driver_configuration}</td><td>${p.dimensions_mm.width}×${p.dimensions_mm.height}×${p.dimensions_mm.depth}</td><td>${p.cutout_dimensions_mm?.diameter??'–'}</td><td>${p.weatherproof?'Yes':'No'}</td><td>${p.has_100v_taps?(p.max_tap_w_100v+' W'):'–'}</td><td class='edit-cell' contenteditable>${p.price_eur}</td><td class='edit-cell' contenteditable>${p.buy_link}</td>`;const [priceCell,linkCell]=tr.querySelectorAll('.edit-cell');priceCell.onblur=()=>p.price_eur=priceCell.innerText.trim();linkCell.onblur=()=>p.buy_link=linkCell.innerText.trim();tb.appendChild(tr);});}
function download(){const blob=new Blob([JSON.stringify(products,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='speakers_updated.json';a.click();URL.revokeObjectURL(url);}
async function save(){if(!token){token=prompt('GitHub PAT (contents:write):','');if(!token)return;sessionStorage.setItem('gh_tok',token);}const ri=repoInfo();if(!ri){alert('Not on GitHub Pages');return;}const path=(ri.path?ri.path+'/':'')+(BUNDLE||'speakers.json');const api=`https://api.github.com/repos/${ri.owner}/${ri.repo}/contents/${path}`;let sha=null;try{sha=(await gh(api,'GET')).sha;}catch{}
 const body={message:'Update via selector',content:btoa(unescape(encodeURIComponent(JSON.stringify(products,null,2)))),branch:BRANCH,sha};await gh(api,'PUT',body);alert('Saved!');}
async function gh(url,method,body){const r=await fetch(url,{method,headers:{'Authorization':'token '+token,'Accept':'application/vnd.github+json'},body:body?JSON.stringify(body):undefined});if(!r.ok)throw new Error(r.status+' '+r.statusText);return r.json();}
function repoInfo(){const ri=repoInfo.cache||detectRepo();return repoInfo.cache=ri;}
loadAll();
</script>
</body>
</html>
