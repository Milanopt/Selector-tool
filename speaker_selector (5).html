<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Speaker Selector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui, sans-serif;padding:1rem;background:#f9fafb;color:#111;line-height:1.4}
    h1{font-size:1.8rem;margin-bottom:1rem}
    label{font-size:.9rem;font-weight:600;margin-right:.25rem}
    input,select{padding:.25rem .5rem;border:1px solid #ccc;border-radius:4px;font-size:.9rem}
    .filters{display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:.5rem;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.08)}
    th,td{padding:.5rem .75rem;text-align:left;border-bottom:1px solid #eee;font-size:.85rem}
    th{background:#f1f5f9;text-transform:uppercase;font-size:.75rem;letter-spacing:.02em}
    tr:last-child td{border-bottom:none}
    @media(max-width:700px){table,thead,tbody,th,td,tr{display:block}thead{display:none}td{border:none;position:relative;padding-left:50%}td::before{content:attr(data-label);position:absolute;left:0;width:45%;padding-left:.75rem;font-weight:600;background:#f1f5f9;height:100%;top:0}}
  </style>
</head>
<body>
<h1>Speaker Selector</h1>

<div class="filters">
  <div>
    <label for="search">Search</label>
    <input id="search" type="text" placeholder="brand or model" />
  </div>
  <div>
    <label for="mount">Mount</label>
    <select id="mount">
      <option value="">Any</option>
      <option value="surface mount">Surface</option>
      <option value="ceiling mount">Ceiling</option>
      <option value="pendant">Pendant</option>
    </select>
  </div>
  <div>
    <label for="minPower">Min RMS W</label>
    <input id="minPower" type="number" min="0" step="5" style="width:6rem" />
  </div>
  <div>
    <label for="maxPower">Max RMS W</label>
    <input id="maxPower" type="number" min="0" step="5" style="width:6rem" />
  </div>
  <div>
    <label for="imp">Impedance Ω</label>
    <select id="imp">
      <option value="">Any</option>
      <option value="4">4 Ω</option>
      <option value="6">6 Ω</option>
      <option value="8">8 Ω</option>
      <option value="16">16 Ω</option>
    </select>
  </div>
  <div style="display:flex;align-items:center;gap:.25rem">
    <input id="weather" type="checkbox" />
    <label for="weather">Weatherproof</label>
  </div>
  <div style="display:flex;align-items:center;gap:.25rem">
    <input id="has100v" type="checkbox" />
    <label for="has100v">100 V taps</label>
  </div>
</div>

<table id="results">
  <thead>
    <tr>
      <th>Brand</th><th>Model</th><th>Mount</th><th>RMS W</th><th>Ω</th><th>Sens dB</th><th>Max SPL dB</th><th>Disp H×V°</th><th>Driver</th><th>Dims mm (W×H×D)</th><th>WP</th><th>100 V</th><th>Tap W</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// ------------------------------------------------------------
// Zero‑configuration GitHub pages auto‑discovery
// ------------------------------------------------------------
// 1. If this file is served from a GitHub Pages URL like:
//      https://<user>.github.io/<repo>/sub/dir/speaker_selector.html
//    we can derive <user>, <repo> and the sub‑directory automatically.
// 2. For any other hosting origin (Netlify, custom domain, localhost)
//    you can still hard‑set GH_OWNER / GH_REPO / DATA_DIR below.
// ------------------------------------------------------------

function guessGitHubContext() {
  // Only works for *.github.io domains
  if (!location.hostname.endsWith('.github.io')) return null;
  const owner = location.hostname.split('.')[0];
  const pathParts = location.pathname.split('/').filter(Boolean); // removes leading ""
  if (!pathParts.length) return null; // no repo segment
  const repo = pathParts[0];
  const subPath = pathParts.slice(1, -1).join('/'); // drop the html filename itself
  return { owner, repo, subPath };
}

// ────────────────────────────────────────────────────────────
//  You can override these if auto‑detection is not enough.
// ────────────────────────────────────────────────────────────
const ctx = guessGitHubContext() || {};
const GH_OWNER = ctx.owner  || "";  // e.g. "acme‑corp"
const GH_REPO  = ctx.repo   || "";  // e.g. "speaker‑selector"
const DATA_DIR = ctx.subPath || ""; // sub‑folder within repo where JSON lives
const BRANCH   = "main";            // change if you use "gh‑pages" / "master"

//------------------------------------------------------------
// Local fallback list – used when served via file:// or
// when auto‑detection fails (e.g. not on GitHub Pages).
//------------------------------------------------------------
const fallbackFiles = [
  "audac-ateo6m-8ohm.json",
  "audac-ateo6dm-16ohm.json"
];

let products = [];

async function listJsonFilesFromGitHub(owner, repo, directory, branch) {
  if (!owner || !repo) throw new Error("GitHub context not set — please edit GH_OWNER / GH_REPO.");
  const dirEncoded = directory ? encodeURIComponent(directory) : "";
  const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${dirEncoded}?ref=${branch}`;
  const res = await fetch(apiUrl);
  if (!res.ok) throw new Error("GitHub API error: " + res.status);
  const items = await res.json();
  return items
    .filter(it => it.type === "file" && it.name.toLowerCase().endsWith(".json"))
    .map(it => it.download_url);
}

async function loadProducts() {
  try {
    let urls;
    if (location.protocol.startsWith("http") && !location.hostname.startsWith("localhost")) {
      // Try GitHub API first
      urls = await listJsonFilesFromGitHub(GH_OWNER, GH_REPO, DATA_DIR, BRANCH);
    }
    if (!urls || !urls.length) {
      // Fallback to local list (relative paths)
      urls = fallbackFiles;
    }

    const responses = await Promise.all(urls.map(u => fetch(u)));
    const jsons = await Promise.all(responses.map(r => {
      if (!r.ok) throw new Error(`Failed to fetch ${r.url} (${r.status})`);
      return r.json();
    }));
    // Each file can either be one object or an array of objects
    products = jsons.flat();
    applyFilters();
  } catch (err) {
    console.error(err);
    document.querySelector('#results tbody').innerHTML = `<tr><td colspan="13" style="color:#b91c1c;padding:1rem">Failed to load product data.<br>${err.message}</td></tr>`;
  }
}

document.addEventListener('DOMContentLoaded', loadProducts);

// ---------- Filtering UI ----------
const tbody = document.querySelector('#results tbody');
const mounts = document.getElementById('mount');
const minP = document.getElementById('minPower');
const maxP = document.getElementById('maxPower');
const imp = document.getElementById('imp');
const wp = document.getElementById('weather');
const line100 = document.getElementById('has100v');
const search = document.getElementById('search');

[ mounts, minP, maxP, imp, wp, line100, search ].forEach(el => el.addEventListener('input', applyFilters));

function applyFilters(){
  const term = search.value.toLowerCase();
  const data = products.filter(p => {
    if (term && !(p.brand+" "+p.model).toLowerCase().includes(term)) return false;
    if (mounts.value && p.mount_type!==mounts.value) return false;
    if (imp.value && p.impedance_ohm.toString()!==imp.value) return false;
    if (minP.value && p.rms_power_w < parseFloat(minP.value)) return false;
    if (maxP.value && p.rms_power_w > parseFloat(maxP.value)) return false;
    if (wp.checked && !p.weatherproof) return false;
    if (line100.checked && !p.has_100v_taps) return false;
    return true;
  });
  renderTable(data);
}

function renderTable(rows){
  tbody.innerHTML = rows.map(r => {
    const disp = `${r.dispersion_deg.horizontal}×${r.dispersion_deg.vertical}`;
    const dims = `${r.dimensions_mm.width}×${r.dimensions_mm.height}×${r.dimensions_mm.depth}`;
    return `<tr>
      <td data-label="Brand">${r.brand}</td>
      <td data-label="Model">${r.model}</td>
      <td data-label="Mount">${r.mount_type}</td>
      <td data-label="RMS W">${r.rms_power_w}</td>
      <td data-label="Ω">${r.impedance_ohm}</td>
      <td data-label="Sens dB">${r.sensitivity_db_1w1m}</td>
      <td data-label="Max SPL">${r.max_spl_db}</td>
      <td data-label="Disp">${disp}</td>
      <td data-label="Driver">${r.driver_configuration}</td>
      <td data-label="Dims">${dims}</td>
      <td data-label="WP">${r.weatherproof?"✔":""}</td>
      <td data-label="100V">${r.has_100v_taps?"✔":""}</td>
      <td data-label="Tap W">${r.max_tap_w_100v??""}</td>
    </tr>`;
  }).join("");
  if (!rows.length) tbody.innerHTML = '<tr><td colspan="13">No matches</td></tr>';
}
</script>
</body>
</html>
