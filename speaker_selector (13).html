<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Speaker Selector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,sans-serif;padding:1rem;background:#f9fafb;color:#111;line-height:1.4}
    h1{font-size:1.8rem;margin-bottom:1rem}
    .filters{display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem;align-items:center}
    label{font-size:.85rem;font-weight:600;margin-right:.25rem}
    select,input[type=number],input[type=text]{padding:.25rem .5rem;font-size:.85rem}
    table{border-collapse:collapse;width:100%;background:#fff}
    th,td{border:1px solid #e5e7eb;padding:.5rem;text-align:left;font-size:.85rem}
    th{background:#f1f5f9;cursor:pointer;user-select:none}
    th.sort-asc::after{content:" ▲"}
    th.sort-desc::after{content:" ▼"}
    tbody tr:nth-child(odd){background:#f9fafb}
    td.edit-cell{background:#fff8dc}
    button{padding:.4rem .8rem;border:1px solid #ccc;border-radius:4px;background:#fff;cursor:pointer;font-size:.85rem}
    .btn-bar{margin:.5rem 0;display:flex;gap:.5rem}
  </style>
</head>
<body>
  <h1>Speaker Selector</h1>

  <div class="filters">
    <div>
      <label for="mountFilter">Mount&nbsp;type:</label>
      <select id="mountFilter">
        <option value="">Any</option>
        <option value="surface mount">Surface</option>
        <option value="ceiling mount">Ceiling</option>
        <option value="pendant">Pendant</option>
      </select>
    </div>

    <div>
      <label for="powerMin">Min&nbsp;RMS&nbsp;W:</label>
      <input type="number" id="powerMin" min="0" placeholder="0" style="width:5rem">
    </div>

    <div>
      <label for="impedanceFilter">Impedance:</label>
      <select id="impedanceFilter">
        <option value="">Any</option>
        <option value="4">4 Ω</option>
        <option value="6">6 Ω</option>
        <option value="8">8 Ω</option>
        <option value="16">16 Ω</option>
      </select>
    </div>

    <div>
      <label><input type="checkbox" id="weatherFilter"> Weatherproof</label>
    </div>

    <div>
      <label><input type="checkbox" id="lineFilter"> 100&nbsp;V&nbsp;capable</label>
    </div>

    <div>
      <label for="searchBox">Search:</label>
      <input type="text" id="searchBox" placeholder="brand or model">
    </div>
  </div>

  <div class="btn-bar">
    <button id="downloadBtn">Download JSON</button>
    <button id="saveBtn">Save to GitHub</button>
  </div>

  <table>
    <thead>
      <tr id="headerRow">
        <th data-key="brand">Brand</th>
        <th data-key="model">Model</th>
        <th data-key="mount_type">Mount</th>
        <th data-key="rms_power_w" data-numeric="1">RMS&nbsp;W</th>
        <th data-key="impedance_ohm" data-numeric="1">Ω</th>
        <th data-key="sensitivity_db_1w1m" data-numeric="1">Sens&nbsp;dB</th>
        <th data-key="max_spl_db" data-numeric="1">Max&nbsp;SPL</th>
        <th data-key="dispersion_deg" data-numeric="0">Disp&nbsp;H°/V°</th>
        <th data-key="driver_configuration">Driver</th>
        <th data-key="dimensions_mm" data-numeric="0">Dims&nbsp;mm</th>
        <th data-key="cutout_dimensions_mm" data-numeric="1">Cut‑out&nbsp;Ø&nbsp;mm</th>
        <th data-key="weatherproof">Weather</th>
        <th data-key="max_tap_w_100v" data-numeric="1">100&nbsp;V&nbsp;max</th>
        <th data-key="price_eur" data-numeric="1">Price&nbsp;€</th>
        <th data-key="buy_link">Link</th>
      </tr>
    </thead>
    <tbody id="productBody">
      <tr><td colspan="15" style="text-align:center">Loading…</td></tr>
    </tbody>
  </table>

<script>
// ----------------- RUNTIME CONFIG (detected automatically) -----------------
const BRANCH = "main";            // branch to pull from / push to
const BUNDLE_FILE = "speakers.json"; // single‑file catalogue (leave "" to load *.json)

// local fallback list while testing over file:// or localhost
const FALLBACK_FILES = [
  "audac-ateo4mk2-8ohm.json","audac-ateo4d-16ohm.json","audac-cira724-8ohm.json",
  "biamp-c-ic6-8ohm.json","bose-dm5c-8ohm.json","bose-dm5se-8ohm.json",
  "bose-dm6c-8ohm.json","bose-dm6se-8ohm.json","bose-dm8s-8ohm.json",
  "bose-dm10s-sub-8ohm.json"
];
// --------------------------------------------------------------------------

let products = [];
let sortKey = null, sortAsc = true;
let GH_TOKEN = sessionStorage.getItem('gh_token')||"";

// ------------- STARTUP -------------
document.addEventListener('DOMContentLoaded', loadProducts);

function detectRepo(){
  if(!location.hostname.endsWith('github.io')) return null;
  const owner = location.hostname.split('.')[0];
  const pathParts = location.pathname.split('/').filter(Boolean);
  if(pathParts.length===0) return null;            // user site root
  const repo = pathParts[0];
  const subPath = pathParts.slice(1,-1).join('/'); // folder(s) between repo & file
  return {owner,repo,subPath};
}

async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(r.status+" "+r.statusText);
  return r.json();
}

async function loadProducts(){
  const gh = detectRepo();
  let urls = [];
  if(gh){
    const rawBase = `https://raw.githubusercontent.com/${gh.owner}/${gh.repo}/${BRANCH}/${gh.subPath?gh.subPath+'/':''}`;
    // try bundle first
    if(BUNDLE_FILE){
      try{
        products = (await fetchJSON(rawBase+BUNDLE_FILE)).map(normalise);
        initUI();
        return;
      }catch(e){console.warn('Bundle not found',e);}
    }
    // else list directory
    try{
      const api = `https://api.github.com/repos/${gh.owner}/${gh.repo}/contents/${gh.subPath}?ref=${BRANCH}`;
      const list = await fetchJSON(api);
      urls = list.filter(i=>i.name.endsWith('.json')).map(i=>i.download_url);
    }catch(e){console.warn('GitHub API list failed',e);}
  }
  if(urls.length===0) urls = FALLBACK_FILES.slice();
  await Promise.all(urls.map(u=>fetchJSON(u).then(d=>products.push(normalise(d))).catch(console.warn)));
  initUI();
}

function normalise(o){
  if(o.price_eur===undefined) o.price_eur="";
  if(o.buy_link===undefined)  o.buy_link="";
  return o;
}

// ---------------- UI INIT ----------------
function initUI(){
  attachFilterEvents();
  attachHeaderSort();
  document.getElementById('downloadBtn').onclick=downloadJSON;
  document.getElementById('saveBtn').onclick=saveToGitHub;
  applyFilters();
}

function attachFilterEvents(){
  [
    'mountFilter','powerMin','impedanceFilter','weatherFilter',
    'lineFilter','searchBox'
  ].forEach(id=>document.getElementById(id).addEventListener('input',applyFilters));
}

function attachHeaderSort(){
  document.querySelectorAll('#headerRow th').forEach(th=>{
    th.addEventListener('click',()=>{
      const key = th.dataset.key;
      sortAsc = sortKey===key ? !sortAsc : true;
      sortKey = key;
      document.querySelectorAll('#headerRow th').forEach(h=>h.classList.remove('sort-asc','sort-desc'));
      th.classList.add(sortAsc?'sort-asc':'sort-desc');
      applyFilters();
    });
  });
}

// ---------------- FILTERING + SORTING ----------------
function applyFilters(){
  const g=id=>document.getElementById(id);
  const mount=g('mountFilter').value;
  const pMin=+g('powerMin').value||0;
  const imp=g('impedanceFilter').value;
  const weather=g('weatherFilter').checked;
  const line=g('lineFilter').checked;
  const term=g('searchBox').value.toLowerCase();

  let list=products.filter(p=>
    (!mount||p.mount_type===mount)&&
    (p.rms_power_w>=pMin)&&
    (!imp||String(p.impedance_ohm)===imp)&&
    (!weather||p.weatherproof)&&
    (!line||p.has_100v_taps)&&
    (!term||(p.brand+" "+p.model).toLowerCase().includes(term))
  );
  if(sortKey) list.sort((a,b)=>compare(a,b));
  renderTable(list);
}

function compare(a,b){
  const va=value(a), vb=value(b);
  if(va===vb) return 0;
  if(va===undefined) return 1;
  if(vb===undefined) return -1;
  return (va>vb?1:-1)*(sortAsc?1:-1);
  function value(o){
    switch(sortKey){
      case 'dispersion_deg': return o.dispersion_deg.horizontal;
      case 'dimensions_mm':  return o.dimensions_mm.width;
      case 'cutout_dimensions_mm':return o.cutout_dimensions_mm?.diameter;
      case 'weatherproof':   return o.weatherproof?1:0;
      case 'price_eur':      return parseFloat(o.price_eur)||0;
      default:               return o[sortKey];
    }
  }
}

// ---------------- TABLE RENDER ----------------
function renderTable(list){
  const tbody=document.getElementById('productBody');
  tbody.innerHTML='';
  if(!list.length){tbody.innerHTML=`<tr><td colspan="15" style="text-align:center">No matches</td></tr>`;return;}
  list.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${p.brand}</td>
      <td>${p.model}</td>
      <td
